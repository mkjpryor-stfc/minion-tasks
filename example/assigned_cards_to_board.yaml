description: Import assigned cards from Trello to another board.

providers:
  - !!minion/provider:minion.connectors.trello.Session
    name: trello
    api_key: !!minion/parameter "trello.api_key"
    api_token: !!minion/parameter "trello.api_token"

spec:
  !!minion/function:minion.functions.compose
  functions:
    - !!minion/function:minion.connectors.trello.cards_assigned_to_user
      session: !!minion/get_provider "trello"

    # The output of this step is a tuple containing two iterables - (assigned cards, cards on destination board)
    - !!minion/function:minion.functions.fork_join
      functions:
        - !!minion/function:minion.functions.identity
        - !!minion/function:minion.connectors.trello.cards_for_board
          session: !!minion/get_provider "trello"
          board_name: !!minion/parameter "trello.board_name"

    # The output of this step is an iterable of (assigned card, card on board)
    # tuples based on the matcher
    # If there is no matching card, the "card on board" is None
    - !!minion/function:minion.functions.zip_matching
      matcher:
        !!minion/function:minion.functions.expression
        expression: "input.0.shortUrl in input.1.attachments|map(attribute='url')"

    # Throw away the tuples which already have a card on the destination board
    - !!minion/function:minion.functions.select
      predicate:
        !!minion/function:minion.functions.expression
        expression: "input.1 is none"

    # Map the remaining tuples to (card, containing board) tuples
    - !!minion/function:minion.functions.collect
      function:
        !!minion/function:minion.functions.fork_join
        functions:
          - !!minion/function:minion.functions.expression
            expression: "input.0"
          - !!minion/function:minion.functions.compose
            functions:
              # First, extract the board id from the card
              - !!minion/function:minion.functions.expression
                expression: "input.0.idBoard"
              # Then find the board by id
              - !!minion/function:minion.connectors.trello.find_board_by_id
                session: !!minion/get_provider "trello"

    # Map the resulting (card, board) tuples onto a card structure
    - !!minion/function:minion.functions.collect
      function:
        !!minion/function:minion.functions.template
        template: |
          {% set card, board = input -%}
          name: >-
            {{ card.name }}
          attachments:
            - "{{ card.shortUrl }}"
          labels:
            - name: trello
              color: red
            - name: "{{ board.name }}"
              color: green

    # Create a card for each of the structures
    - !!minion/function:minion.functions.collect
      function:
        !!minion/function:minion.connectors.trello.create_card
        session: !!minion/get_provider "trello"
        board_name: !!minion/parameter "trello.board_name"
        list_name: !!minion/parameter "trello.list_name"
